{% extends 'layout.html' %}

{% block title %}Add Project{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Add New Project</h2>
  <form id="projectForm">
    <div class="mb-3">
      <label class="form-label">Project Name</label>
      <input type="text" class="form-control" name="name" required />
    </div>

    <div class="mb-3">
      <label class="form-label">Number</label>
      <input type="text" class="form-control" name="number" required />
    </div>

    <div class="mb-3">
      <label class="form-label">Description</label>
      <textarea class="form-control" name="description" required></textarea>
    </div>

    <div class="mb-3">
      <label class="form-label">Status</label>
      <select class="form-select" name="status" required>
        <option value="Backlog">Backlog</option>
        <option value="To Do">To Do</option>
        <option value="In Progress">In Progress</option>
        <option value="In Review">In Review</option>
        <option value="Done">Done</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Deadline</label>
      <input type="date" class="form-control" name="dealine" required />
    </div>

    <div class="mb-3">
      <label class="form-label">Reporter</label>
      <select class="form-select" name="reporter" id="reporterSelect" required></select>
    </div>

    <div class="mb-3">
      <label class="form-label">Assignees</label>
      <select class="form-select" name="assignees" id="assigneeSelect" multiple></select>
    </div>

    <button type="submit" class="btn btn-primary">Create Project</button>
  </form>
</div>

<script>
  async function loadAccounts() {
    try {
      const res = await fetch("/api/accounts/");
      const accounts = await res.json();

      const reporterSelect = document.getElementById("reporterSelect");
      const assigneeSelect = document.getElementById("assigneeSelect");

      accounts.forEach(account => {
        const option1 = document.createElement("option");
        option1.value = account.id;
        option1.text = account.username;
        reporterSelect.appendChild(option1);

        const option2 = document.createElement("option");
        option2.value = account.id;
        option2.text = account.username;
        assigneeSelect.appendChild(option2);
      });
    } catch (error) {
      console.error("Lỗi khi tải danh sách accounts:", error);
    }
  }

  document.getElementById("projectForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const form = e.target;
    const assigneeSelect = document.getElementById("assigneeSelect");
    const selectedAssignees = Array.from(assigneeSelect.selectedOptions).map(opt => parseInt(opt.value));

    const data = {
      name: form.name.value,
      number: form.number.value,  // thêm trường number
      description: form.description.value,
      status: form.status.value,
      dealine: form.dealine.value,
      reporter: parseInt(form.reporter.value),
      assignees: selectedAssignees
    };

    try {
      const res = await fetch("/api/projects/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify(data)
      });

      const result = await res.json();

      if (res.ok) {
        alert("Thêm dự án thành công!");
        window.location.href = "{% url 'projects_view' %}";
      } else {
        alert("Lỗi: " + JSON.stringify(result));
      }
    } catch (error) {
      alert("Có lỗi xảy ra khi gửi dữ liệu.");
      console.error(error);
    }
  });

  // Tải danh sách account khi vào trang
  loadAccounts();
</script>
{% endblock %}
